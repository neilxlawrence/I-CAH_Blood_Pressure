The purpose of this file is to perform extrapolation for height between measured points, and to use a hierarchical within patient modelling approach to detect outliers

Search for the chunK:
Setting limits for extrapolation and scaled residual threshold for assessing outliers
to adjust the parameters for extrapolating outside of the range and for how carefully to look and correct for outliers

Load packages and reread files using the prebuilt load files function

```{r, load software packages}
rm(list = ls())

#we first establish the location of the working directory where we keep everything, depending on whether it exists (i.e. which computer we are using)
#check C drive
if(file.exists("C:/Users/User/Documents/NRL_R_work/iCAH_Blood_pressure")){
location_of_main_folder <-
  "C:/Users/User/Documents/NRL_R_work/iCAH_Blood_pressure"
}
#take the working directory otherwise, which should work every time?
if(!exists("location_of_main_folder")){
  location_of_main_folder <- 
    getwd()
}
#paste the name of our functions folder into the path name
location_of_functions_folder <-
  paste0(location_of_main_folder, "/bp_functions_folder/")

#load the function that loads all the libraries and sources
source(paste0(location_of_functions_folder, "load_bp_libraries_and_sources_function.R"))

#paste together the location of the data files - we don't load in the first file, but we need this location for the end
location_of_data_files <-
  paste0(location_of_main_folder, "/bp_data_files_to_load/")

#run the function, pointing it towards the functions folder
load_bp_libraries_and_sources_function(
  location_of_functions_folder=location_of_functions_folder,
  location_of_data_files=location_of_data_files
)

load_bp_files_function(previous_file_name = "file_17",
  parent_directory = location_of_data_files,
  list_of_data_frames_to_load=list("bp_data"))

```

*********************
Setting limits for extrapolation and scaled residual threshold for assessing outliers
*********************

```{r, Setting limits for extrapolation and scaled residual threshold for assessing outliers}
print("Whilst we will definitely want to interpolate between points, it becomes more dangerous to extrapolate beyond them. Here we set the limits for both height and weight that we will accept extrapolation. If these are set to zero, then we don't extrapolate at all.")

number_of_years_to_extrapolate_before_for_height <- 0

number_of_years_to_extrapolate_after_for_height <- 0

number_of_years_to_extrapolate_before_for_weight <- 0

number_of_years_to_extrapolate_after_for_weight <- 0

print("We fit GAM models and assess the scaled residual threshold to look for outliers, we set this within the code here. We will need a different figure for GAM models compared to spline and linear interpolations. ")
gam_scaled_residual_threshold_for_height <- 3

spline_pearson_residual_threshold_for_height <- 0.5

spline_degrees_of_freedom_less_than_points <- 5

print("The linear interpolation then just fits points between points, it doesn't assess for outliers. Any outlier detection for individual points or overall patients (i.e. those who either have individual outlying points, or who have multiple points but they are all outlying (for instance if their date of birth hadn't been entered correctly and their growth curve was shifted in a direction, would have to have outlier detection within the whole frame)")
```

*******************************************************************************************************************
interpolation of height within patients using a hierarchical approach with GAM, spline, then straight line interpolations
*******************************************************************************************************************

```{r, using gam in mgcv within patients to create multivariable interpolations for height using height and weight for patients with 11 observations}
library("mgcv")

require("nlme")

#create empty data frames to join results to
all_gam_height_weight_age_interpolations <- 
  data.frame(NULL)

all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam <- 
  data.frame(NULL)

all_model_height_using_gam_with_age_weight_residuals_frame <- 
  data.frame(NULL)

id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame <- 
  data.frame(NULL)

for (id_to_impute in unique(bp_data$id)){


#take out data for our ID    
id_data_with_age_weight_height_to_model <- 
  subset(bp_data, id==id_to_impute)  

#print where we are in the loop
print("id is:")
cat(id_to_impute)

print("number of rows for this ID is:")
cat(nrow(id_data_with_age_weight_height_to_model))

id_data_with_age_weight_height_to_model <- 
  subset(id_data_with_age_weight_height_to_model, !is.na(manually_corrected_height))

id_data_with_age_weight_height_to_model <- 
  subset(id_data_with_age_weight_height_to_model, !is.na(manually_corrected_weight))

id_data_with_age_weight_height_to_model <- 
  subset(id_data_with_age_weight_height_to_model, !is.na(age_to_use))

cat("number of rows with age weight and height to model is:")

cat(nrow(id_data_with_age_weight_height_to_model))

#pull out the earliest age where we have data for this patient
earliest_age_with_data <- min(id_data_with_age_weight_height_to_model$age_to_use)

oldest_age_with_data <- max(id_data_with_age_weight_height_to_model$age_to_use)

#use our thresholds for extrapolation to define ages above and beyond which we will fit the spline
earliest_age_to_apply_the_model_to_this_patient <- 
  earliest_age_with_data - number_of_years_to_extrapolate_before_for_height

oldest_age_to_apply_the_model_to_this_patient <- 
  oldest_age_with_data + number_of_years_to_extrapolate_after_for_height

#skip the modelling if we don't have enough points for multivariable GAM
if (sum(!is.na(unique(id_data_with_age_weight_height_to_model$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_weight_height_to_model$manually_corrected_weight))) < 11 |
    sum(!is.na(unique(id_data_with_age_weight_height_to_model$age_to_use))) < 11 ) next

#collect the id's which were used
all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam_to_join <-
  data.frame(id=id_to_impute)

#join it into a frame outside the loop
all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam <-
  rbind(all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam,
        all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam_to_join)

#take out just the columns for our model and name it the first iteration, as this first iteration will be reiterated if it has outliers
id_data_with_age_weight_height_to_model_first_iteration <-
  id_data_with_age_weight_height_to_model[,c(
    "id",
    "id_visit_date",
    "manually_corrected_height",
    "manually_corrected_weight",
    "age_to_use")]

#fit a gam model wih age and weight as a covariate
model_height_using_gam_with_age_weight <- 
  mgcv::gam(manually_corrected_height ~ 
            s(age_to_use) + 
            s(manually_corrected_weight) , 
          data=id_data_with_age_weight_height_to_model_first_iteration
  )

#we take out our residuals from this model to help with outlier detection
summary(model_height_using_gam_with_age_weight)
#plot(model_height_using_gam_with_age_weight)

#add residuals to that frame. We use scaled pearson residuals 
id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals <-
  residuals(model_height_using_gam_with_age_weight,
          type="scaled.pearson")
#we need a correction here - if the fit is perfect then the residuals will be infinite. we need to change them to zero
id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals <-
  ifelse(
    id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals=="Inf" |
      id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals=="-Inf",
    0,
    id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals
  )

#create an absolute version of the residuals to easily compare against our threshold
id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals_absolute <-
  ifelse(
    id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals < 0,
    id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals * -1,
    id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals
  )

#pull out the id_visit_date and the residuals from this gam model to add to a frame outside of the loop
all_model_height_using_gam_with_age_weight_residuals_frame_to_add <-
  id_data_with_age_weight_height_to_model_first_iteration[,c(
    "id_visit_date",
    "model_height_using_gam_with_age_weight_residuals")]

#ensure we state the iteration number for these residuals
all_model_height_using_gam_with_age_weight_residuals_frame_to_add$iteration <- 
  1

#bind them outside of the loop
all_model_height_using_gam_with_age_weight_residuals_frame <-
  rbind(all_model_height_using_gam_with_age_weight_residuals_frame,
        all_model_height_using_gam_with_age_weight_residuals_frame_to_add)

#########################################################################################
#marking 1st worst residual outlier, removing, and refitting the model
#########################################################################################
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_weight_height_to_model_first_iteration$model_height_using_gam_with_age_weight_residuals_absolute) > 
    gam_scaled_residual_threshold_for_height){
  
  #take out the row with the worst residual
  worst_id_data_with_age_weight_height_to_model <-
    id_data_with_age_weight_height_to_model_first_iteration %>% 
    group_by(id) %>%
    slice_max(model_height_using_gam_with_age_weight_residuals_absolute, with_ties = F, n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_weight_height_to_model$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight = 1,
                 height_outlier_flag_method = "model_height_using_gam_with_age_weight",
                 height_gam_age_weight_iteration_outlier_was_flagged = 1)
    
    #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame_to_add)
    
  #create a second iteration frame to remodel
    id_data_with_age_weight_height_to_model_second_iteration <-
      subset(id_data_with_age_weight_height_to_model, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a GAM model 
  #realise that this means we may flag some outliers through gam modelling, but will be left without a value for a predicted gam model  
if (sum(!is.na(unique(id_data_with_age_weight_height_to_model_second_iteration$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_weight_height_to_model_second_iteration$manually_corrected_weight))) < 11 |
    sum(!is.na(unique(id_data_with_age_weight_height_to_model_second_iteration$age_to_use))) < 11 ) next

  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    model_height_using_gam_with_age_weight <- 
      mgcv::gam(manually_corrected_height ~ 
                s(age_to_use) + 
                s(manually_corrected_weight) , 
                data=id_data_with_age_weight_height_to_model_second_iteration
  )
  #add residuals to that second iteration frame. We use scaled pearson residuals 
  id_data_with_age_weight_height_to_model_second_iteration$model_height_using_gam_with_age_weight_residuals <-
    residuals(model_height_using_gam_with_age_weight,
              type="scaled.pearson")
  
  #create an absolute version of the residuals
  id_data_with_age_weight_height_to_model_second_iteration$model_height_using_gam_with_age_weight_residuals_absolute <-
    ifelse(
      id_data_with_age_weight_height_to_model_second_iteration$model_height_using_gam_with_age_weight_residuals < 0,
      id_data_with_age_weight_height_to_model_second_iteration$model_height_using_gam_with_age_weight_residuals * -1,
      id_data_with_age_weight_height_to_model_second_iteration$model_height_using_gam_with_age_weight_residuals
      )

  #pull out the id_visit_date and the residuals from this gam model to add to a frame outside of the loop
  all_model_height_using_gam_with_age_weight_residuals_frame_to_add <-
    id_data_with_age_weight_height_to_model_second_iteration[,c(
      "id_visit_date",
      "model_height_using_gam_with_age_weight_residuals")]

  #ensure we state the iteration number for these residuals
  all_model_height_using_gam_with_age_weight_residuals_frame_to_add$iteration <- 2

  #bind them outside of the frame
  all_model_height_using_gam_with_age_weight_residuals_frame <-
    rbind(all_model_height_using_gam_with_age_weight_residuals_frame,
          all_model_height_using_gam_with_age_weight_residuals_frame_to_add)
#########################################################################################
#marking 2nd worst residual outlier, removing, and refitting the model
#########################################################################################    
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_weight_height_to_model_second_iteration$model_height_using_gam_with_age_weight_residuals_absolute) > 
    gam_scaled_residual_threshold_for_height){
  worst_id_data_with_age_weight_height_to_model_second_iteration <-
    id_data_with_age_weight_height_to_model_second_iteration %>% 
    group_by(id) %>%
    slice_max(model_height_using_gam_with_age_weight_residuals_absolute, 
              with_ties = F, 
              n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_weight_height_to_model_second_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight = 1,
                 height_outlier_flag_method = "model_height_using_gam_with_age_weight",
                 height_gam_age_weight_iteration_outlier_was_flagged = 2)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame_to_add)
  
  #create a third iteration frame to remodel
    id_data_with_age_weight_height_to_model_third_iteration <-
      subset(id_data_with_age_weight_height_to_model_second_iteration, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a GAM model 
if (sum(!is.na(unique(id_data_with_age_weight_height_to_model_third_iteration$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_weight_height_to_model_third_iteration$manually_corrected_weight))) < 11 |
    sum(!is.na(unique(id_data_with_age_weight_height_to_model_third_iteration$age_to_use))) < 11 ) next
  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    model_height_using_gam_with_age_weight <- 
      mgcv::gam(manually_corrected_height ~ 
                s(age_to_use) + 
                s(manually_corrected_weight) , 
                data=id_data_with_age_weight_height_to_model_third_iteration
  )
    
  #add residuals to that third iteration frame. We use scaled pearson residuals 
  id_data_with_age_weight_height_to_model_third_iteration$model_height_using_gam_with_age_weight <-
    residuals(model_height_using_gam_with_age_weight,
              type="scaled.pearson")
  
  #create an absolute version of the residuals
  id_data_with_age_weight_height_to_model_third_iteration$model_height_using_gam_with_age_weight_residuals_absolute <-
    ifelse(
      id_data_with_age_weight_height_to_model_third_iteration$model_height_using_gam_with_age_weight_residuals < 0,
      id_data_with_age_weight_height_to_model_third_iteration$model_height_using_gam_with_age_weight_residuals * -1,
      id_data_with_age_weight_height_to_model_third_iteration$model_height_using_gam_with_age_weight_residuals
      )

  #pull out the id_visit_date and the residuals from this gam model to add to a frame outside of the loop
  all_model_height_using_gam_with_age_weight_residuals_frame_to_add <-
    id_data_with_age_weight_height_to_model_third_iteration[,c(
      "id_visit_date",
      "model_height_using_gam_with_age_weight_residuals")]

  #ensure we state the iteration number for these residuals
  all_model_height_using_gam_with_age_weight_residuals_frame_to_add$iteration <- 3

  #bind them outside of the frame
  all_model_height_using_gam_with_age_weight_residuals_frame <-
    rbind(all_model_height_using_gam_with_age_weight_residuals_frame,
          all_model_height_using_gam_with_age_weight_residuals_frame_to_add)

#########################################################################################
#marking 3rd worst residual outlier, removing, and refitting the model
#########################################################################################    
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_weight_height_to_model_third_iteration$model_height_using_gam_with_age_weight_residuals_absolute) > 
    gam_scaled_residual_threshold_for_height){
  worst_id_data_with_age_weight_height_to_model_third_iteration <-
    id_data_with_age_weight_height_to_model_third_iteration %>% 
    group_by(id) %>%
    slice_max(model_height_using_gam_with_age_weight_residuals_absolute, with_ties = F, n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_weight_height_to_model_third_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight = 1,
                 height_outlier_flag_method = "model_height_using_gam_with_age_weight",
                 height_gam_age_weight_iteration_outlier_was_flagged = 3)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame_to_add)
  
  #create a fourth iteration frame to remodel
    id_data_with_age_weight_height_to_model_fourth_iteration <-
      subset(id_data_with_age_weight_height_to_model_third_iteration, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a GAM model 
if (sum(!is.na(unique(id_data_with_age_weight_height_to_model_fourth_iteration$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_weight_height_to_model_fourth_iteration$manually_corrected_weight))) < 11 |
    sum(!is.na(unique(id_data_with_age_weight_height_to_model_fourth_iteration$age_to_use))) < 11 ) next
  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    model_height_using_gam_with_age_weight <- 
      mgcv::gam(manually_corrected_height ~ 
                s(age_to_use) + 
                s(manually_corrected_weight) , 
                data=id_data_with_age_weight_height_to_model_fourth_iteration
  )
    
  #add residuals to that third iteration frame. We use scaled pearson residuals 
  id_data_with_age_weight_height_to_model_fourth_iteration$model_height_using_gam_with_age_weight <-
    residuals(model_height_using_gam_with_age_weight,
              type="scaled.pearson")
  
  #create an absolute version of the residuals
  id_data_with_age_weight_height_to_model_fourth_iteration$model_height_using_gam_with_age_weight_residuals_absolute <-
    ifelse(
      id_data_with_age_weight_height_to_model_fourth_iteration$model_height_using_gam_with_age_weight_residuals < 0,
      id_data_with_age_weight_height_to_model_fourth_iteration$model_height_using_gam_with_age_weight_residuals * -1,
      id_data_with_age_weight_height_to_model_fourth_iteration$model_height_using_gam_with_age_weight_residuals
      )

  #pull out the id_visit_date and the residuals from this gam model to add to a frame outside of the loop
  all_model_height_using_gam_with_age_weight_residuals_frame_to_add <-
    id_data_with_age_weight_height_to_model_fourth_iteration[,c(
      "id_visit_date",
      "model_height_using_gam_with_age_weight_residuals")]

  #ensure we state the iteration number for these residuals
  all_model_height_using_gam_with_age_weight_residuals_frame_to_add$iteration <- 3

  #bind them outside of the frame
  all_model_height_using_gam_with_age_weight_residuals_frame <-
    rbind(all_model_height_using_gam_with_age_weight_residuals_frame,
          all_model_height_using_gam_with_age_weight_residuals_frame_to_add)

#########################################################################################
#marking 4th worst residual outlier, removing, and refitting the model
#########################################################################################    
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_weight_height_to_model_fourth_iteration$model_height_using_gam_with_age_weight_residuals_absolute) > 
    gam_scaled_residual_threshold_for_height){
  worst_id_data_with_age_weight_height_to_model_fourth_iteration <-
    id_data_with_age_weight_height_to_model_fourth_iteration %>% 
    group_by(id) %>%
    slice_max(model_height_using_gam_with_age_weight_residuals_absolute, with_ties = F, n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_weight_height_to_model_fourth_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight = 1,
                 height_outlier_flag_method = "model_height_using_gam_with_age_weight",
                 height_gam_age_weight_iteration_outlier_was_flagged = 4)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame_to_add)
  
  #create a fifth iteration frame to remodel
    id_data_with_age_weight_height_to_model_fifth_iteration <-
      subset(id_data_with_age_weight_height_to_model_fourth_iteration, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a GAM model 
if (sum(!is.na(unique(id_data_with_age_weight_height_to_model_fifth_iteration$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_weight_height_to_model_fifth_iteration$manually_corrected_weight))) < 11 |
    sum(!is.na(unique(id_data_with_age_weight_height_to_model_fifth_iteration$age_to_use))) < 11 ) next
  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    model_height_using_gam_with_age_weight <- 
      mgcv::gam(manually_corrected_height ~ 
                s(age_to_use) + 
                s(manually_corrected_weight) , 
                data=id_data_with_age_weight_height_to_model_fifth_iteration
  )
  #this is where we stop iterating, and use that as the final model, after four iterations of the worst outlier has been removed  
}}}}

#collect the id's which were used and made it through without outliers being removed to the point where there was no longer enough data to fit a gam
all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam_to_join <-
  data.frame(id=id_to_impute)

#join it into a frame outside the loop
all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam <-
  rbind(all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam,
        all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam_to_join)


#those iterative if loops above should mean that we have a final gam model that is called model_height_using_gam_with_age_weight fit to the data for that patient having removed any necessary outliers, depending upon the residual threshold we have set

#we don't need to adjust points for outliers at this stage, we have the model fitted to points without outliers. They can get changed during the hierarchical change

#take out our data for that patient again so that we have all of it to fit and impute
new_data_with_weight_and_age <-
  data.frame(
    id = bp_data$id,
    id_visit_date = bp_data$id_visit_date,
    age_to_use = bp_data$age_to_use,
    manually_corrected_weight = bp_data$manually_corrected_weight
  )

#now use that model to interpolate any points for this patient id that are missing

#take out just this patient
new_data_with_weight_and_age <-
  subset(new_data_with_weight_and_age, 
         id==id_to_impute)

#we take out those without weight and age, as we can't fit this model without weight and age as they are the predictors
new_data_with_weight_and_age <-
  subset(new_data_with_weight_and_age, 
         !is.na(manually_corrected_weight))

new_data_with_weight_and_age <-
  subset(new_data_with_weight_and_age, 
         !is.na(age_to_use))

#subset just the data that is bounded by our limits of extrapolation
new_data_with_weight_and_age <- 
  subset(
    new_data_with_weight_and_age,
      age_to_use >= earliest_age_to_apply_the_model_to_this_patient &
      age_to_use <= oldest_age_to_apply_the_model_to_this_patient
  )

#use predict to fit our GAM model and this time call it interpolate
new_data_with_weight_and_age$interpolate_height_using_gam_with_age_weight <- 
  predict(model_height_using_gam_with_age_weight, 
          na.action = na.omit, 
          newdata = new_data_with_weight_and_age)

#join in our interpolations using GAM weight and age to the main frame
bp_data_with_gam_height_weight_age_interpolations <-
  left_join(
    bp_data, 
    new_data_with_weight_and_age, 
    by = (c(
      "id",
      "id_visit_date", 
      "age_to_use", 
      "manually_corrected_weight")))

#if height is missing, use the gam interpolation that uses age and weight as covariates
bp_data_with_gam_height_weight_age_interpolations$gam_interpolated_height_using_age_weight <-
  ifelse(is.na(bp_data_with_gam_height_weight_age_interpolations$manually_corrected_height),
         bp_data_with_gam_height_weight_age_interpolations$interpolate_height_using_gam_with_age_weight,
         bp_data_with_gam_height_weight_age_interpolations$manually_corrected_height)

#subset out just this patient
id_data_with_gam_height_weight_age_interpolations <- 
  subset(bp_data_with_gam_height_weight_age_interpolations, 
         id==id_to_impute)

#flag where we have interpolated a point because it was originally missing. We need to have both a missing original value AND a value for a point that can be used for interpolation - if we didn't have weight then we wouldn't be able to use the gam model for height weight and age
id_data_with_gam_height_weight_age_interpolations$gam_interpolated_height_using_age_weight_flag <-
  ifelse(is.na(id_data_with_gam_height_weight_age_interpolations$manually_corrected_height) &
   !is.na(id_data_with_gam_height_weight_age_interpolations$interpolate_height_using_gam_with_age_weight) ,
         1,
         0)

#join in our information about outliers
#put a hack in here if we haven't found any outliers, to facilitate a join
if(nrow(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame)==0){
  id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame <- data.frame(id_visit_date="null_frame",
                                                                     manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight=0,
                                                                     height_outlier_flag_method="no_outliers",
                                                                     height_gam_age_weight_iteration_outlier_was_flagged = 0)
}


id_data_with_gam_height_weight_age_interpolations_with_outlier_info <-
  left_join(
    id_data_with_gam_height_weight_age_interpolations,
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_weight_frame,
    by="id_visit_date"
  )

#after joining, we now need to complete that column to ensure anyone who isn't flagged has a zero to prevent NA's ruining the ifelse going forward
id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight <-
  ifelse(id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight!=1 |
           is.na(id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight),
         0,
         id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight)

#if height has been flagged as an outlier, then use the gam interpolation that uses age and weight
id_data_with_gam_height_weight_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_weight <-
  ifelse((id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight==1),
         id_data_with_gam_height_weight_age_interpolations_with_outlier_info$interpolate_height_using_gam_with_age_weight,
         id_data_with_gam_height_weight_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_weight)

#if we are flagged as an outlier, then we also need to be flagged as an interpolated point
id_data_with_gam_height_weight_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_weight_flag <-
  ifelse((id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight==1) ,
         1,
         id_data_with_gam_height_weight_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_weight_flag)

#correct our column height_gam_age_weight_iteration_outlier_was_flagged to zero if it isn't flagged
id_data_with_gam_height_weight_age_interpolations_with_outlier_info$height_gam_age_weight_iteration_outlier_was_flagged <-
  ifelse(id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight==0,
         0,
         id_data_with_gam_height_weight_age_interpolations_with_outlier_info$height_gam_age_weight_iteration_outlier_was_flagged)
         

id_data_with_gam_height_weight_age_interpolations_to_bind <- 
  id_data_with_gam_height_weight_age_interpolations_with_outlier_info[,c(
    "id_visit_date",
    "gam_interpolated_height_using_age_weight",
    "gam_interpolated_height_using_age_weight_flag",
    "manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight",
    "height_gam_age_weight_iteration_outlier_was_flagged")]

all_gam_height_weight_age_interpolations <- 
  rbind(all_gam_height_weight_age_interpolations,
        id_data_with_gam_height_weight_age_interpolations_to_bind)

gam_interpolated_height_using_age_weight_plot <- 
  ggplot(data=id_data_with_gam_height_weight_age_interpolations_with_outlier_info, 
         aes(x=age_to_use, 
             y=gam_interpolated_height_using_age_weight)) + 
  geom_point(data=
               subset(id_data_with_gam_height_weight_age_interpolations_with_outlier_info, 
                      gam_interpolated_height_using_age_weight_flag==0),
    aes(), alpha=0.5, colour="blue") +
  geom_point(data=
               subset(id_data_with_gam_height_weight_age_interpolations_with_outlier_info, 
                      gam_interpolated_height_using_age_weight_flag==1),
    aes(), alpha=0.5, colour="orange") +
  geom_point(data=
               subset(id_data_with_gam_height_weight_age_interpolations_with_outlier_info, 
                      manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight==1),
    aes(y=manually_corrected_height), alpha=1, colour="red") +
  geom_line(data=subset(id_data_with_gam_height_weight_age_interpolations_with_outlier_info, #we subset here just to ensure there's no gaps in our gam line caused by NAs
                        !is.na(interpolate_height_using_gam_with_age_weight)),
            aes(x=age_to_use, 
             y=interpolate_height_using_gam_with_age_weight)) + 
  labs(title="Blue is original data that is reasonable, orange is interpolated data point, red is original data that has been flagged as an outlier",
       subtitle=paste0("Number of outliers flagged = ",
                       sum(id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight==1),
                       ", Number of interpolated points = ",
                       sum(id_data_with_gam_height_weight_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_weight_flag==1),
                       ", St. Residual threshold:",
                       gam_scaled_residual_threshold_for_height))+
  themewithlegend

gam_interpolated_height_using_age_weight_plot

dir.create(paste0("gam_height_imputation_plots_using_weight_age"))
dir.create(paste0("gam_height_imputation_plots_using_weight_age/residual_threshold_", 
                  gam_scaled_residual_threshold_for_height))
dir.create(paste0("gam_height_imputation_plots_using_weight_age/residual_threshold_", 
                  gam_scaled_residual_threshold_for_height, 
                  "/all_individual_interpolations"))

ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path=paste0("gam_height_imputation_plots_using_weight_age/residual_threshold_", 
                   gam_scaled_residual_threshold_for_height, 
                   "/all_individual_interpolations"),
       plot = gam_interpolated_height_using_age_weight_plot, 
       device="tiff",  
       width=10, height=5, 
       compression = "lzw", limitsize=F)

if(sum(
  id_data_with_gam_height_weight_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight==1)>0){
dir.create(paste0("gam_height_imputation_plots_using_weight_age/residual_threshold_", 
                  gam_scaled_residual_threshold_for_height, 
                  "/individual_interpolations_with_outliers"))
ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path=paste0("gam_height_imputation_plots_using_weight_age/residual_threshold_", 
                   gam_scaled_residual_threshold_for_height, 
                   "/individual_interpolations_with_outliers"),
       plot = gam_interpolated_height_using_age_weight_plot, 
       device="tiff",  
       width=10, height=5, 
       compression = "lzw", limitsize=F)
}

if(sum(
  id_data_with_gam_height_weight_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_weight_flag==1) > 0 ){
dir.create(paste0("gam_height_imputation_plots_using_weight_age/residual_threshold_", 
                  gam_scaled_residual_threshold_for_height, 
                  "/individual_interpolations_leading_to_interpolated_points"))
ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path=paste0("gam_height_imputation_plots_using_weight_age/residual_threshold_", 
                   gam_scaled_residual_threshold_for_height, 
                   "/individual_interpolations_leading_to_interpolated_points"),
       plot = gam_interpolated_height_using_age_weight_plot, 
       device="tiff",  
       width=10, height=5, 
       compression = "lzw", limitsize=F)
}

}
```

```{r, using gam in mgcv within patients to create multivariable interpolations for height using age only for patients with 11 observations}
#create empty data frames to join results to
all_gam_height_age_interpolations <- 
  data.frame(NULL)

all_ids_with_enough_id_data_with_age_height_to_model_for_gam <- 
  data.frame(NULL)

all_model_height_using_gam_with_age_residuals_frame <- 
  data.frame(NULL)

id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame <- 
  data.frame(NULL)

for (id_to_impute in unique(bp_data$id)){

#take out data for our ID    
id_data_with_age_height_to_model <- 
  subset(bp_data, id==id_to_impute)  

#print where we are in the loop
cat("id is:")
cat(id_to_impute)

cat("number of rows for this ID is:")
cat(nrow(id_data_with_age_height_to_model))

id_data_with_age_height_to_model <- 
  subset(id_data_with_age_height_to_model, 
         !is.na(manually_corrected_height) &
           !is.na(age_to_use))

cat("number of rows with age and height to model is:")

cat(nrow(id_data_with_age_height_to_model))

#pull out the earliest age where we have data for this patient
earliest_age_with_data <- 
  min(id_data_with_age_height_to_model$age_to_use)

oldest_age_with_data <- 
  max(id_data_with_age_height_to_model$age_to_use)

#use our thresholds for extrapolation to define ages above and beyond which we will fit the spline
earliest_age_to_apply_the_model_to_this_patient <- 
  earliest_age_with_data - number_of_years_to_extrapolate_before_for_height

oldest_age_to_apply_the_model_to_this_patient <- 
  oldest_age_with_data + number_of_years_to_extrapolate_after_for_height

#skip the modelling if we don't have enough points for multivariable GAM
if (sum(!is.na(unique(id_data_with_age_height_to_model$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_height_to_model$age_to_use))) < 11 ) next

#take out just the columns for our model and name it the first iteration, as this first iteration will be reiterated if it has outliers
id_data_with_age_height_to_model_first_iteration <-
  id_data_with_age_height_to_model[,c(
    "id",
    "id_visit_date",
    "manually_corrected_height",
    "age_to_use")]

#fit a gam model wih age as a predictor
model_height_using_gam_with_age <- 
  mgcv::gam(manually_corrected_height ~ 
            s(age_to_use)  , 
          data=id_data_with_age_height_to_model_first_iteration
  )

#we take out our residuals from this model to help with outlier detection
summary(model_height_using_gam_with_age)
#plot(model_height_using_gam_with_age)

#add residuals to that frame. We use scaled pearson residuals 
id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals <-
  residuals(model_height_using_gam_with_age,
          type="scaled.pearson")
#we need a correction here - if the fit is perfect then the residuals will be infinite. we need to change them to zero
id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals <-
  ifelse(
    id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals=="Inf" |
      id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals=="-Inf",
    0,
    id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals
  )

#create an absolute version of the residuals to easily compare against our threshold
id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals_absolute <-
  ifelse(
    id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals < 0,
    id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals * -1,
    id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals
  )

#pull out the id_visit_date and the residuals from this gam model to add to a frame outside of the loop
all_model_height_using_gam_with_age_residuals_frame_to_add <-
  id_data_with_age_height_to_model_first_iteration[,c(
    "id_visit_date",
    "model_height_using_gam_with_age_residuals")]

#ensure we state the iteration number for these residuals
all_model_height_using_gam_with_age_residuals_frame_to_add$iteration <- 
  1

#bind them outside of the loop
all_model_height_using_gam_with_age_residuals_frame <-
  rbind(all_model_height_using_gam_with_age_residuals_frame,
        all_model_height_using_gam_with_age_residuals_frame_to_add)

#########################################################################################
#marking 1st worst residual outlier, removing, and refitting the model
#########################################################################################
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_height_to_model_first_iteration$model_height_using_gam_with_age_residuals_absolute) > 
    gam_scaled_residual_threshold_for_height){
  
  #take out the row with the worst residual
  worst_id_data_with_age_height_to_model <-
    id_data_with_age_height_to_model_first_iteration %>% 
    group_by(id) %>%
    slice_max(model_height_using_gam_with_age_residuals_absolute, with_ties = F, n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_height_to_model$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_gam_age = 1,
                 height_outlier_flag_method = "model_height_using_gam_with_age",
                 height_gam_age_iteration_outlier_was_flagged = 1)
    
    #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame_to_add)
    
  #create a second iteration frame to remodel
    id_data_with_age_height_to_model_second_iteration <-
      subset(id_data_with_age_height_to_model, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a GAM model 
  #realise that this means we may flag some outliers through gam modelling, but will be left without a value for a predicted gam model  
if (sum(!is.na(unique(id_data_with_age_height_to_model_second_iteration$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_height_to_model_second_iteration$age_to_use))) < 11 ) next

  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    model_height_using_gam_with_age <- 
      mgcv::gam(manually_corrected_height ~ 
                s(age_to_use)  , 
                data=id_data_with_age_height_to_model_second_iteration
  )
  #add residuals to that second iteration frame. We use scaled pearson residuals 
  id_data_with_age_height_to_model_second_iteration$model_height_using_gam_with_age_residuals <-
    residuals(model_height_using_gam_with_age,
              type="scaled.pearson")
  
  #create an absolute version of the residuals
  id_data_with_age_height_to_model_second_iteration$model_height_using_gam_with_age_residuals_absolute <-
    ifelse(
      id_data_with_age_height_to_model_second_iteration$model_height_using_gam_with_age_residuals < 0,
      id_data_with_age_height_to_model_second_iteration$model_height_using_gam_with_age_residuals * -1,
      id_data_with_age_height_to_model_second_iteration$model_height_using_gam_with_age_residuals
      )

  #pull out the id_visit_date and the residuals from this gam model to add to a frame outside of the loop
  all_model_height_using_gam_with_age_residuals_frame_to_add <-
    id_data_with_age_height_to_model_second_iteration[,c(
      "id_visit_date",
      "model_height_using_gam_with_age_residuals")]

  #ensure we state the iteration number for these residuals
  all_model_height_using_gam_with_age_residuals_frame_to_add$iteration <- 2

  #bind them outside of the frame
  all_model_height_using_gam_with_age_residuals_frame <-
    rbind(all_model_height_using_gam_with_age_residuals_frame,
          all_model_height_using_gam_with_age_residuals_frame_to_add)
#########################################################################################
#marking 2nd worst residual outlier, removing, and refitting the model
#########################################################################################    
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_height_to_model_second_iteration$model_height_using_gam_with_age_residuals_absolute) > 
    gam_scaled_residual_threshold_for_height){
  worst_id_data_with_age_height_to_model_second_iteration <-
    id_data_with_age_height_to_model_second_iteration %>% 
    group_by(id) %>%
    slice_max(model_height_using_gam_with_age_residuals_absolute, 
              with_ties = F, 
              n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_height_to_model_second_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_gam_age = 1,
                 height_outlier_flag_method = "model_height_using_gam_with_age",
                 height_gam_age_iteration_outlier_was_flagged = 2)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame_to_add)
  
  #create a third iteration frame to remodel
    id_data_with_age_height_to_model_third_iteration <-
      subset(id_data_with_age_height_to_model_second_iteration, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a GAM model 
if (sum(!is.na(unique(id_data_with_age_height_to_model_third_iteration$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_height_to_model_third_iteration$age_to_use))) < 11 ) next
  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    model_height_using_gam_with_age <- 
      mgcv::gam(manually_corrected_height ~ 
                s(age_to_use)  , 
                data=id_data_with_age_height_to_model_third_iteration
  )
    
  #add residuals to that third iteration frame. We use scaled pearson residuals 
  id_data_with_age_height_to_model_third_iteration$model_height_using_gam_with_age <-
    residuals(model_height_using_gam_with_age,
              type="scaled.pearson")
  
  #create an absolute version of the residuals
  id_data_with_age_height_to_model_third_iteration$model_height_using_gam_with_age_residuals_absolute <-
    ifelse(
      id_data_with_age_height_to_model_third_iteration$model_height_using_gam_with_age_residuals < 0,
      id_data_with_age_height_to_model_third_iteration$model_height_using_gam_with_age_residuals * -1,
      id_data_with_age_height_to_model_third_iteration$model_height_using_gam_with_age_residuals
      )

  #pull out the id_visit_date and the residuals from this gam model to add to a frame outside of the loop
  all_model_height_using_gam_with_age_residuals_frame_to_add <-
    id_data_with_age_height_to_model_third_iteration[,c(
      "id_visit_date",
      "model_height_using_gam_with_age_residuals")]

  #ensure we state the iteration number for these residuals
  all_model_height_using_gam_with_age_residuals_frame_to_add$iteration <- 3

  #bind them outside of the frame
  all_model_height_using_gam_with_age_residuals_frame <-
    rbind(all_model_height_using_gam_with_age_residuals_frame,
          all_model_height_using_gam_with_age_residuals_frame_to_add)

#########################################################################################
#marking 3rd worst residual outlier, removing, and refitting the model
#########################################################################################    
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_height_to_model_third_iteration$model_height_using_gam_with_age_residuals_absolute) > 
    gam_scaled_residual_threshold_for_height){
  worst_id_data_with_age_height_to_model_third_iteration <-
    id_data_with_age_height_to_model_third_iteration %>% 
    group_by(id) %>%
    slice_max(model_height_using_gam_with_age_residuals_absolute, with_ties = F, n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_height_to_model_third_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_gam_age = 1,
                 height_outlier_flag_method = "model_height_using_gam_with_age",
                 height_gam_age_iteration_outlier_was_flagged = 3)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame_to_add)
  
  #create a fourth iteration frame to remodel
    id_data_with_age_height_to_model_fourth_iteration <-
      subset(id_data_with_age_height_to_model_third_iteration, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a GAM model 
if (sum(!is.na(unique(id_data_with_age_height_to_model_fourth_iteration$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_height_to_model_fourth_iteration$age_to_use))) < 11 ) next
  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    model_height_using_gam_with_age <- 
      mgcv::gam(manually_corrected_height ~ 
                s(age_to_use) , 
                data=id_data_with_age_height_to_model_fourth_iteration
  )
    
  #add residuals to that third iteration frame. We use scaled pearson residuals 
  id_data_with_age_height_to_model_fourth_iteration$model_height_using_gam_with_age <-
    residuals(model_height_using_gam_with_age,
              type="scaled.pearson")
  
  #create an absolute version of the residuals
  id_data_with_age_height_to_model_fourth_iteration$model_height_using_gam_with_age_residuals_absolute <-
    ifelse(
      id_data_with_age_height_to_model_fourth_iteration$model_height_using_gam_with_age_residuals < 0,
      id_data_with_age_height_to_model_fourth_iteration$model_height_using_gam_with_age_residuals * -1,
      id_data_with_age_height_to_model_fourth_iteration$model_height_using_gam_with_age_residuals
      )

  #pull out the id_visit_date and the residuals from this gam model to add to a frame outside of the loop
  all_model_height_using_gam_with_age_residuals_frame_to_add <-
    id_data_with_age_height_to_model_fourth_iteration[,c(
      "id_visit_date",
      "model_height_using_gam_with_age_residuals")]

  #ensure we state the iteration number for these residuals
  all_model_height_using_gam_with_age_residuals_frame_to_add$iteration <- 3

  #bind them outside of the frame
  all_model_height_using_gam_with_age_residuals_frame <-
    rbind(all_model_height_using_gam_with_age_residuals_frame,
          all_model_height_using_gam_with_age_residuals_frame_to_add)

#########################################################################################
#marking 4th worst residual outlier, removing, and refitting the model
#########################################################################################    
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_height_to_model_fourth_iteration$model_height_using_gam_with_age_residuals_absolute) > 
    gam_scaled_residual_threshold_for_height){
  worst_id_data_with_age_height_to_model_fourth_iteration <-
    id_data_with_age_height_to_model_fourth_iteration %>% 
    group_by(id) %>%
    slice_max(model_height_using_gam_with_age_residuals_absolute, with_ties = F, n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_height_to_model_fourth_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_gam_age = 1,
                 height_outlier_flag_method = "model_height_using_gam_with_age",
                 height_gam_age_iteration_outlier_was_flagged = 4)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame_to_add)
  
  #create a fifth iteration frame to remodel
    id_data_with_age_height_to_model_fifth_iteration <-
      subset(id_data_with_age_height_to_model_fourth_iteration, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a GAM model 
if (sum(!is.na(unique(id_data_with_age_height_to_model_fifth_iteration$manually_corrected_height))) < 11 | 
    sum(!is.na(unique(id_data_with_age_height_to_model_fifth_iteration$age_to_use))) < 11 ) next
  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    model_height_using_gam_with_age <- 
      mgcv::gam(manually_corrected_height ~ 
                s(age_to_use)  , 
                data=id_data_with_age_height_to_model_fifth_iteration
  )
  #this is where we stop iterating, and use that as the final model, after four iterations of the worst outlier has been removed  
}}}}

#collect the id's which were used
all_ids_with_enough_id_data_with_age_height_to_model_for_gam_to_join <-
  data.frame(id=id_to_impute)

#join it into a frame outside the loop
all_ids_with_enough_id_data_with_age_height_to_model_for_gam <-
  rbind(all_ids_with_enough_id_data_with_age_height_to_model_for_gam,
        all_ids_with_enough_id_data_with_age_height_to_model_for_gam_to_join)


#those iterative if loops above should mean that we have a final gam model that is called model_height_using_gam_with_age fit to the data for that patient having removed any necessary outliers, depending upon the residual threshold we have set

#we don't need to adjust points for outliers at this stage, we have the model fitted to points without outliers. They can get changed during the hierarchical change

#take out our data for that patient again so that we have all of it to fit and impute
new_data_with_age <-
  data.frame(
    id = bp_data$id,
    id_visit_date = bp_data$id_visit_date,
    age_to_use = bp_data$age_to_use
  )

#now use that model to interpolate any points for this patient id that are missing

#take out just this patient
new_data_with_age <-
  subset(new_data_with_age, 
         id==id_to_impute)

#we take out those without age, as we can't fit this model without age as that is the predictor
new_data_with_age <-
  subset(new_data_with_age, 
         !is.na(age_to_use))

#subset just the data that is bounded by our limits of extrapolation
new_data_with_age <- 
  subset(
    new_data_with_age,
      age_to_use >= earliest_age_to_apply_the_model_to_this_patient &
      age_to_use <= oldest_age_to_apply_the_model_to_this_patient
  )

#use predict to fit our GAM model and this time call it interpolate
new_data_with_age$interpolate_height_using_gam_with_age <- 
  predict(model_height_using_gam_with_age, 
          na.action = na.omit, 
          newdata = new_data_with_age)

#join in our interpolations using GAM age to the main frame
bp_data_with_gam_height_age_interpolations <-
  left_join(
    bp_data, 
    new_data_with_age, 
    by = (c(
      "id",
      "id_visit_date", 
      "age_to_use")))

#if height is missing, use the gam interpolation that uses age to predict
bp_data_with_gam_height_age_interpolations$gam_interpolated_height_using_age <-
  ifelse(is.na(bp_data_with_gam_height_age_interpolations$manually_corrected_height),
         bp_data_with_gam_height_age_interpolations$interpolate_height_using_gam_with_age,
         bp_data_with_gam_height_age_interpolations$manually_corrected_height)

#subset out just this patient
id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations <- 
  subset(bp_data_with_gam_height_age_interpolations, 
         id==id_to_impute)

#flag where we have interpolated a point because it was originally missing. We need to have both a missing original value AND a value for a point that can be used for interpolation - if we didn't have id_data_with_gam_height_age_interpolations then we wouldn't be able to use the gam model for height id_data_with_gam_height_age_interpolations and age
id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations$gam_interpolated_height_using_age_flag <-
  ifelse(is.na(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations$manually_corrected_height) &
   !is.na(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations$interpolate_height_using_gam_with_age) ,
         1,
         0)

#join in our information about outliers
#put a hack in here if we haven't found any outliers, to facilitate a join
if(nrow(id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame)==0){
  id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame <- 
    data.frame(id_visit_date="null_frame",
               manually_corrected_height_flagged_as_an_outlier_by_gam_age=0,
               height_outlier_flag_method="no_outliers",
               height_gam_age_iteration_outlier_was_flagged = 0)
}


id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info <-
  left_join(
    id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations,
    id_visit_dates_with_height_flagged_as_outliers_from_gam_age_frame,
    by="id_visit_date"
  )

#after joining, we now need to complete that column to ensure anyone who isn't flagged has a zero to prevent NA's ruining the ifelse going forward
id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age <-
  ifelse(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age!=1 |
        is.na(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age),
        0,
        id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age)

#if height has been flagged as an outlier, then use the gam interpolation that uses age and id_data_with_gam_height_age_interpolations
id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$gam_interpolated_height_using_age <-
  ifelse((id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age==1),
         id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$interpolate_height_using_gam_with_age,
         id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$gam_interpolated_height_using_age)

#if we are flagged as an outlier, then we also need to be flagged as an interpolated point
id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_flag <-
  ifelse((id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age==1) ,
         1,
         id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_flag)

#correct our column height_gam_age_iteration_outlier_was_flagged to zero if it isn't flagged
id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$height_gam_age_iteration_outlier_was_flagged <-
  ifelse(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age==0,
         0,
         id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$height_gam_age_iteration_outlier_was_flagged)
         

id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_to_bind <- 
  id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info[,c(
    "id_visit_date",
    "gam_interpolated_height_using_age",
    "gam_interpolated_height_using_age_flag",
    "manually_corrected_height_flagged_as_an_outlier_by_gam_age",
    "height_gam_age_iteration_outlier_was_flagged")]

all_gam_height_age_interpolations <- 
  rbind(all_gam_height_age_interpolations,
        id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_to_bind)

gam_interpolated_height_using_age_plot <- 
  ggplot(data=id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info, 
         aes(x=age_to_use, 
             y=gam_interpolated_height_using_age)) + 
  geom_point(data=
               subset(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info, 
                      gam_interpolated_height_using_age_flag==0),
    aes(), alpha=0.5, colour="blue") +
  geom_point(data=
               subset(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info, 
                      gam_interpolated_height_using_age_flag==1),
    aes(), alpha=0.5, colour="orange") +
  geom_point(data=
               subset(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info, 
                      manually_corrected_height_flagged_as_an_outlier_by_gam_age==1),
    aes(y=manually_corrected_height), alpha=1, colour="red") +
  geom_line(data=subset(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info, #we subset here just to ensure there's no gaps in our gam line caused by NAs
                        !is.na(interpolate_height_using_gam_with_age)),
            aes(x=age_to_use, 
             y=interpolate_height_using_gam_with_age)) + 
  labs(title="Blue is original data that is reasonable, orange is interpolated data point, red is original data that has been flagged as an outlier",
       subtitle=paste0("Number of outliers flagged = ",
                       sum(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age==1),
                       ", Number of interpolated points = ",
                       sum(id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_flag==1),
                       ", St. Residual threshold:",
                       gam_scaled_residual_threshold_for_height))+
  themewithlegend

gam_interpolated_height_using_age_plot

dir.create(paste0("gam_height_imputation_plots_using_age"))
dir.create(paste0("gam_height_imputation_plots_using_age/residual_threshold_", 
                  gam_scaled_residual_threshold_for_height))
dir.create(paste0("gam_height_imputation_plots_using_age/residual_threshold_", 
                  gam_scaled_residual_threshold_for_height, 
                  "/all_individual_interpolations"))

ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path=paste0("gam_height_imputation_plots_using_age/residual_threshold_", 
                   gam_scaled_residual_threshold_for_height, 
                   "/all_individual_interpolations"),
       plot = gam_interpolated_height_using_age_plot, 
       device="tiff",  
       width=10, height=5, 
       compression = "lzw", limitsize=F)

if(sum(
  id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_gam_age==1)>0){
dir.create(paste0("gam_height_imputation_plots_using_age/residual_threshold_", 
                  gam_scaled_residual_threshold_for_height, 
                  "/individual_interpolations_with_outliers"))
ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path=paste0("gam_height_imputation_plots_using_age/residual_threshold_", 
                   gam_scaled_residual_threshold_for_height, 
                   "/individual_interpolations_with_outliers"),
       plot = gam_interpolated_height_using_age_plot, 
       device="tiff",  
       width=10, height=5, 
       compression = "lzw", limitsize=F)
}

if(sum(
  id_data_with_gam_height_id_data_with_gam_height_age_interpolations_age_interpolations_with_outlier_info$gam_interpolated_height_using_age_flag==1) > 0 ){
dir.create(paste0("gam_height_imputation_plots_using_age/residual_threshold_", 
                  gam_scaled_residual_threshold_for_height, 
                  "/individual_interpolations_leading_to_interpolated_points"))
ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path=paste0("gam_height_imputation_plots_using_age/residual_threshold_", 
                   gam_scaled_residual_threshold_for_height, 
                   "/individual_interpolations_leading_to_interpolated_points"),
       plot = gam_interpolated_height_using_age_plot, 
       device="tiff",  
       width=10, height=5, 
       compression = "lzw", limitsize=F)
}

}
```

```{r, using smooth.spline basic function within patients to create interpolations for height using height for patients with less than 11 observations but more than 3 observations}


#create a frame to join to
all_spline_height_age_interpolations <- 
  data.frame(NULL)

all_ids_with_enough_id_data_for_spline <- 
  data.frame(NULL)

id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame <-
  data.frame(NULL)

#we need to combine the two GAM id list above to find out
all_ids_with_enough_id_data_for_gam <- 
  unique(rbind(
    all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam,
    all_ids_with_enough_id_data_with_age_height_to_model_for_gam
  ))

#take out all other ids to find out which ones we have that haven't had a gam model
all_ids_without_enough_data_for_gam <-
  subset(
    data.frame(id=unique(bp_data$id)), 
         !(id %in% all_ids_with_enough_id_data_for_gam$id))

#now we loop around just the patients that didn't have a GAM
for (id_to_impute in unique(all_ids_without_enough_data_for_gam$id)){


#clear the frame at the beginning of the loop that I use to add to the frame outside of the loop
id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add <- data.frame(NULL)
#id_data$manually_corrected_height
#id_data$age_to_use
id_data <- 
  subset(bp_data, 
         id==id_to_impute)  
print(" ")
cat("id is: ")
cat(id_to_impute)

cat("; number of rows is: ")
cat(nrow(id_data))
print(" ")

#take out the data from the id
id_data <- 
  subset(id_data, 
         !is.na(manually_corrected_height) &
           !is.na(age_to_use))

#pull out the earliest age where we have data for this patient
earliest_age_with_data <- 
  min(id_data$age_to_use)

oldest_age_with_data <- 
  max(id_data$age_to_use)

#use our thresholds for extrapolation to define ages above and beyond which we will fit the spline
earliest_age_to_apply_the_model_to_this_patient <- 
  earliest_age_with_data - 
  number_of_years_to_extrapolate_before_for_height

oldest_age_to_apply_the_model_to_this_patient <- 
  oldest_age_with_data + 
  number_of_years_to_extrapolate_after_for_height

#come out of the loop if we don't have 4 or more observations as we can't fit a spline
if (
  sum(
    !is.na(id_data$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data$age_to_use)) < 4 ) {
  print("Aborted patient before fitting a spline")
}
if (
  sum(
    !is.na(id_data$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data$age_to_use)) < 4 ) next


#pull out the columns we use for the model
id_data <-
  id_data[,c(
    "id",
    "id_visit_date",
    "manually_corrected_height",
    "age_to_use")]

#assign the degrees of freedom for spline fitting
#take the number of points minus the defined spline_degrees_of_freedom_less_than_points
degrees_of_freedom_to_fit_spline <-
    nrow(id_data) - spline_degrees_of_freedom_less_than_points
#correct this if there is 4 or 5 points to be 4, because this is the minimum we can use to fit a spline
degrees_of_freedom_to_fit_spline <-
  ifelse(degrees_of_freedom_to_fit_spline < 4,
         4,
         degrees_of_freedom_to_fit_spline)

#fit a spline with 4 degrees of freedom
spline_model_height_with_age <- 
  smooth.spline(id_data$age_to_use,
                id_data$manually_corrected_height,
                df=degrees_of_freedom_to_fit_spline) 

########################
#Detect Outliers
########################

#create a copy of the data for this patient
id_data_with_spline_model <-
  id_data

# Predict values
id_data_with_spline_model$spline_model_height_with_age <- 
  predict(spline_model_height_with_age)$y

# Calculate residuals
residuals <- 
  id_data_with_spline_model$manually_corrected_height - 
  id_data_with_spline_model$spline_model_height_with_age

# Calculate response variable standard deviation
response_sd <- 
  sqrt(var(id_data_with_spline_model$manually_corrected_height))  # Degree of freedom is length of residuals - 2

# Calculate studentised residuals
id_data_with_spline_model$pearson_residuals <- 
  residuals / response_sd

#put a hack in here to turn any infinite residual into zero for perfect fits
id_data_with_spline_model$pearson_residuals <- 
  ifelse(id_data_with_spline_model$pearson_residuals=="Inf" | 
           id_data_with_spline_model$pearson_residuals=="-Inf" | 
           id_data_with_spline_model$pearson_residuals=="NaN",
         0,
         id_data_with_spline_model$pearson_residuals)

#Calculate absolute studentised residuals 
id_data_with_spline_model$absolute_pearson_residuals <-
  ifelse(id_data_with_spline_model$pearson_residuals < 0,
         -id_data_with_spline_model$pearson_residuals,
         id_data_with_spline_model$pearson_residuals)

#########################################################################################
#marking 1st worst residual outlier, removing, and refitting the model
#########################################################################################
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_spline_model$absolute_pearson_residuals) > 
    spline_pearson_residual_threshold_for_height){
  
  #take out the row with the worst residual
  worst_id_data_with_spline_model <-
    id_data_with_spline_model %>% 
    group_by(id) %>%
    slice_max(absolute_pearson_residuals, 
              with_ties = F, 
              n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at
  
  id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_spline_model$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_spline_age = 1,
                 height_outlier_flag_method = "model_height_using_spline_with_age",
                 height_spline_iteration_outlier_was_flagged = 1)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add)
    
  #create a second iteration frame to remodel
    id_data_with_age_height_to_model_second_iteration <-
      subset(id_data, 
             !(id_visit_date %in% id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a spline model 
  #realise that this means we may flag some outliers through gam modelling, but will be left without a value for a predicted spline model  
if (
  sum(
    !is.na(id_data_with_age_height_to_model_second_iteration$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data_with_age_height_to_model_second_iteration$age_to_use)) < 4 ) {
  print("Aborted loop after removing one outlier")
  }
    if (sum(
  !is.na(id_data_with_age_height_to_model_second_iteration$manually_corrected_height)) < 4 | 
  sum(!is.na(id_data_with_age_height_to_model_second_iteration$age_to_use)) < 4 ) next

  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    #take one off the degrees of freedom because we have removed one
    degrees_of_freedom_to_fit_spline <-
      degrees_of_freedom_to_fit_spline -1
  spline_model_height_with_age <- 
    smooth.spline(id_data_with_age_height_to_model_second_iteration$age_to_use,
                  id_data_with_age_height_to_model_second_iteration$manually_corrected_height,
                  df=degrees_of_freedom_to_fit_spline) 
    
    # Predict values
    id_data_with_age_height_to_model_second_iteration$spline_model_height_with_age <- 
      predict(spline_model_height_with_age)$y

    # Calculate residuals
    residuals <- 
      id_data_with_age_height_to_model_second_iteration$manually_corrected_height - 
      id_data_with_age_height_to_model_second_iteration$spline_model_height_with_age

    # Calculate response variable standard deviation
response_sd <- 
  sqrt(var(id_data_with_age_height_to_model_second_iteration$manually_corrected_height)) # Degree of freedom is length of residuals - 2

    # Calculate studentised residuals
    id_data_with_age_height_to_model_second_iteration$pearson_residuals <- 
      residuals / response_sd
    
#put a hack in here to turn any infinite residual into zero for perfect fits
id_data_with_age_height_to_model_second_iteration$pearson_residuals <- 
  ifelse(id_data_with_age_height_to_model_second_iteration$pearson_residuals=="Inf" | 
           id_data_with_age_height_to_model_second_iteration$pearson_residuals=="-Inf" | 
           id_data_with_age_height_to_model_second_iteration$pearson_residuals=="NaN",
         0,
         id_data_with_age_height_to_model_second_iteration$pearson_residuals)

    #Calculate absolute studentised residuals 
    id_data_with_age_height_to_model_second_iteration$absolute_pearson_residuals <-
      ifelse(id_data_with_age_height_to_model_second_iteration$pearson_residuals <0,
             -id_data_with_age_height_to_model_second_iteration$pearson_residuals,
             id_data_with_age_height_to_model_second_iteration$pearson_residuals)
    
#########################################################################################
#marking 2nd worst residual outlier, removing, and refitting the model
#########################################################################################
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_height_to_model_second_iteration$absolute_pearson_residuals) > 
    spline_pearson_residual_threshold_for_height){
  
  #take out the row with the worst residual
  worst_id_data_with_age_height_to_model_second_iteration <-
    id_data_with_age_height_to_model_second_iteration %>% 
    group_by(id) %>%
    slice_max(absolute_pearson_residuals, 
              with_ties = F, 
              n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at

    id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_height_to_model_second_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_spline_age = 1,
                 height_outlier_flag_method = "model_height_using_spline_with_age",
                 height_spline_iteration_outlier_was_flagged = 2)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add)
    
  #create a third iteration frame to remodel
    id_data_with_age_height_to_model_third_iteration <-
      subset(id_data, 
             !(id_visit_date %in% 
                 id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a spline model 
  #realise that this means we may flag some outliers through gam modelling, but will be left without a value for a predicted spline model  
if (
  sum(
    !is.na(id_data_with_age_height_to_model_third_iteration$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data_with_age_height_to_model_third_iteration$age_to_use)) < 4 ) {
  print("Aborted loop after removing two outliers")
  }
    if (sum(
  !is.na(id_data_with_age_height_to_model_third_iteration$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data_with_age_height_to_model_third_iteration$age_to_use)) < 4 ) next

  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
    #take one off the degrees of freedom because we have removed one
    degrees_of_freedom_to_fit_spline <-
      degrees_of_freedom_to_fit_spline -1    
  spline_model_height_with_age <- 
    smooth.spline(id_data_with_age_height_to_model_third_iteration$age_to_use,
                  id_data_with_age_height_to_model_third_iteration$manually_corrected_height,
                  df=degrees_of_freedom_to_fit_spline) 
    
    # Predict values
    id_data_with_age_height_to_model_third_iteration$spline_model_height_with_age <- 
      predict(spline_model_height_with_age)$y

    # Calculate residuals
    residuals <- 
      id_data_with_age_height_to_model_third_iteration$manually_corrected_height - 
      id_data_with_age_height_to_model_third_iteration$spline_model_height_with_age

    # Calculate response variable standard deviation
response_sd <- 
  sqrt(var(id_data_with_age_height_to_model_third_iteration$manually_corrected_height)) # Degree of freedom is length of residuals - 2

    # Calculate studentised residuals
    id_data_with_age_height_to_model_third_iteration$pearson_residuals <- 
      residuals / response_sd
    
#put a hack in here to turn any infinite residual into zero for perfect fits
id_data_with_age_height_to_model_third_iteration$pearson_residuals <- 
  ifelse(id_data_with_age_height_to_model_third_iteration$pearson_residuals=="Inf" | 
           id_data_with_age_height_to_model_third_iteration$pearson_residuals=="-Inf" | 
           id_data_with_age_height_to_model_third_iteration$pearson_residuals=="NaN",
         0,
         id_data_with_age_height_to_model_third_iteration$pearson_residuals)


    #Calculate absolute studentised residuals 
    id_data_with_age_height_to_model_third_iteration$absolute_pearson_residuals <-
      ifelse(id_data_with_age_height_to_model_third_iteration$pearson_residuals <0,
             -id_data_with_age_height_to_model_third_iteration$pearson_residuals,
             id_data_with_age_height_to_model_third_iteration$pearson_residuals)
    
#########################################################################################
#marking 3rd worst residual outlier, removing, and refitting the model
#########################################################################################
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_height_to_model_third_iteration$absolute_pearson_residuals) > 
    spline_pearson_residual_threshold_for_height){
  
  #take out the row with the worst residual
  worst_id_data_with_age_height_to_model_third_iteration <-
    id_data_with_age_height_to_model_third_iteration %>% 
    group_by(id) %>%
    slice_max(absolute_pearson_residuals, 
              with_ties = F, 
              n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at

    id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_height_to_model_third_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_spline_age = 1,
                 height_outlier_flag_method = "model_height_using_spline_with_age",
                 height_spline_iteration_outlier_was_flagged = 3)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add)
    
  #create a fourth iteration frame to remodel
    id_data_with_age_height_to_model_fourth_iteration <-
      subset(id_data, 
             !(id_visit_date %in% 
                 id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a spline model 
  #realise that this means we may flag some outliers through gam modelling, but will be left without a value for a predicted spline model  
if (
  sum(
    !is.na(id_data_with_age_height_to_model_fourth_iteration$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data_with_age_height_to_model_fourth_iteration$age_to_use)) < 4 ) {
  print("Aborted loop after removing three outliers")
  }
    if (sum(
  !is.na(id_data_with_age_height_to_model_fourth_iteration$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data_with_age_height_to_model_fourth_iteration$age_to_use)) < 4 ) next

  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
        #take one off the degrees of freedom because we have removed one
    degrees_of_freedom_to_fit_spline <-
      degrees_of_freedom_to_fit_spline -1    
  spline_model_height_with_age <- 
    smooth.spline(id_data_with_age_height_to_model_fourth_iteration$age_to_use,
                  id_data_with_age_height_to_model_fourth_iteration$manually_corrected_height,
                  df=degrees_of_freedom_to_fit_spline) 
    
    # Predict values
    id_data_with_age_height_to_model_fourth_iteration$spline_model_height_with_age <- 
      predict(spline_model_height_with_age)$y

    # Calculate residuals
    residuals <- 
      id_data_with_age_height_to_model_fourth_iteration$manually_corrected_height - 
      id_data_with_age_height_to_model_fourth_iteration$spline_model_height_with_age

    # Calculate response variable standard deviation
response_sd <- 
  sqrt(var(id_data_with_age_height_to_model_fourth_iteration$manually_corrected_height))   # Degree of freedom is length of residuals - 2

    # Calculate studentised residuals
    id_data_with_age_height_to_model_fourth_iteration$pearson_residuals <- 
      residuals / response_sd
    
#put a hack in here to turn any infinite residual into zero for perfect fits
id_data_with_age_height_to_model_fourth_iteration$pearson_residuals <- 
  ifelse(id_data_with_age_height_to_model_fourth_iteration$pearson_residuals=="Inf" | 
           id_data_with_age_height_to_model_fourth_iteration$pearson_residuals=="-Inf" | 
           id_data_with_age_height_to_model_fourth_iteration$pearson_residuals=="NaN",
         0,
         id_data_with_age_height_to_model_third_iteration$pearson_residuals)


    #Calculate absolute studentised residuals 
    id_data_with_age_height_to_model_fourth_iteration$absolute_pearson_residuals <-
      ifelse(id_data_with_age_height_to_model_fourth_iteration$pearson_residuals <0,
             -id_data_with_age_height_to_model_fourth_iteration$pearson_residuals,
             id_data_with_age_height_to_model_fourth_iteration$pearson_residuals)
    
#########################################################################################
#marking 4th worst residual outlier, removing, and refitting the model
#########################################################################################
#if we have residuals over our threshold, then we mark the biggest residual as an outlier
if (max(id_data_with_age_height_to_model_fourth_iteration$absolute_pearson_residuals) > 
    spline_pearson_residual_threshold_for_height){
  
  #take out the row with the worst residual
  worst_id_data_with_age_height_to_model_fourth_iteration <-
    id_data_with_age_height_to_model_fourth_iteration %>% 
    group_by(id) %>%
    slice_max(absolute_pearson_residuals, 
              with_ties = F, 
              n=1)
  
  #pull out that id_visit_date flagged as an outlier, tell us what method and what iteration it came out at

    id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add <-
      data.frame(id_visit_date = worst_id_data_with_age_height_to_model_fourth_iteration$id_visit_date,
                 manually_corrected_height_flagged_as_an_outlier_by_spline_age = 1,
                 height_outlier_flag_method = "model_height_using_spline_with_age",
                 height_spline_iteration_outlier_was_flagged = 4)
    
  #bind that to the frame outside of the loop
    id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame <-
      rbind(id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame,
            id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add)
    
  #create a fifth iteration frame to remodel
    id_data_with_age_height_to_model_fifth_iteration <-
      subset(id_data, 
             !(id_visit_date %in% 
                 id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame$id_visit_date))
  
  #then reinsert our clause to skip to the next iteration in the loop if we've dropped below the threshold to be able to fit a spline model 
  #realise that this means we may flag some outliers through gam modelling, but will be left without a value for a predicted spline model  
if (
  sum(
    !is.na(id_data_with_age_height_to_model_fifth_iteration$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data_with_age_height_to_model_fifth_iteration$age_to_use)) < 4 ) {
  print("Aborted loop after removing four outliers")
  }
    if (sum(
  !is.na(id_data_with_age_height_to_model_fifth_iteration$manually_corrected_height)) < 4 | 
  sum(
    !is.na(id_data_with_age_height_to_model_fifth_iteration$age_to_use)) < 4 ) next

  
  #if we haven't skipped, then we can refit our model without using the data without the outlier point  
            #take one off the degrees of freedom because we have removed one
    degrees_of_freedom_to_fit_spline <-
      degrees_of_freedom_to_fit_spline -1    
  spline_model_height_with_age <- 
    smooth.spline(id_data_with_age_height_to_model_fifth_iteration$age_to_use,
                  id_data_with_age_height_to_model_fifth_iteration$manually_corrected_height,
                  df=degrees_of_freedom_to_fit_spline) 
    
#and that will be our final model so we close off our if clauses
}}}}
    
#take out all of the data points for this patient again
new_data_with_just_age <-
  data.frame(
    id = bp_data$id,
    id_visit_date = bp_data$id_visit_date,
    age_to_use = bp_data$age_to_use
  )

#use just this patient
new_data_with_just_age <-
  subset(new_data_with_just_age, 
         id==id_to_impute)

#subset just the data that is bounded by our limits of extrapolation. This will also remove any that has age as an NA
new_data_with_just_age <- 
  subset(
    new_data_with_just_age,
    age_to_use >= earliest_age_to_apply_the_model_to_this_patient &
      age_to_use <= oldest_age_to_apply_the_model_to_this_patient
  )

#apply the spline model to this data from the patient
new_data_with_just_age$spline_model_height_with_age <- 
  predict(spline_model_height_with_age, 
          new_data_with_just_age$age_to_use)$y

#join in the spline model predictions
spline_interpolated_data <-
  left_join(
    bp_data, 
    new_data_with_just_age, 
    by = (c("id_visit_date", 
            "age_to_use",
            "id"
            )))

#create a flag if the height is NA 
spline_interpolated_data$spline_interpolated_height_flag <-
  ifelse(is.na(spline_interpolated_data$manually_corrected_height),
         1,
         0)

#insert the interpolated data if it is NA, or the original data if it is not
spline_interpolated_data$spline_interpolated_height <-
  ifelse(is.na(spline_interpolated_data$manually_corrected_height),
         spline_interpolated_data$spline_model_height_with_age,
         spline_interpolated_data$manually_corrected_height)

#restrict to just this patient
spline_interpolated_data <- 
  subset(spline_interpolated_data, 
         id==id_to_impute)

#take out just the necessary columns
spline_interpolated_data <-
  spline_interpolated_data[,c(
    "id_visit_date",
    "age_to_use",
    "manually_corrected_height",
    "spline_model_height_with_age",
    "spline_interpolated_height"
)]

#join in our information about outliers
#put a hack in here if we haven't found any outliers, to facilitate a join
if(nrow(id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame_to_add)==0){
  id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame <- 
    data.frame(id_visit_date = "null_frame",
               manually_corrected_height_flagged_as_an_outlier_by_spline_age = 0,
               height_outlier_flag_method = "no_outliers",
               height_spline_iteration_outlier_was_flagged = 0)
}


id_data_with_spline_model_with_outlier_info <-
  left_join(
    spline_interpolated_data,
    id_visit_dates_with_height_flagged_as_outliers_from_spline_with_age_frame,
    by="id_visit_date"
  )

#after joining, we now need to complete that column to ensure anyone who isn't flagged has a zero to prevent NA's ruining the ifelse going forward
id_data_with_spline_model_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_spline_age <-
  ifelse(is.na(id_data_with_spline_model_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_spline_age),
        0,
        id_data_with_spline_model_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_spline_age)

#if height has been flagged as an outlier, then use the spline interpolation that uses age 
id_data_with_spline_model_with_outlier_info$spline_interpolated_height <-
  ifelse((id_data_with_spline_model_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_spline_age==1),
         id_data_with_spline_model_with_outlier_info$spline_model_height_with_age,
         id_data_with_spline_model_with_outlier_info$spline_interpolated_height)

#create a flag for interpolated height if we don't have a height value and we have a spline model fit to use
id_data_with_spline_model_with_outlier_info$spline_interpolated_height_flag <-
  ifelse(is.na(id_data_with_spline_model_with_outlier_info$manually_corrected_height) &
           !is.na(id_data_with_spline_model_with_outlier_info$spline_model_height_with_age),
         1,
         0)

#if we are flagged as an outlier, then we also need to be flagged as an interpolated point
id_data_with_spline_model_with_outlier_info$spline_interpolated_height_flag <-
  ifelse((id_data_with_spline_model_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_spline_age==1) ,
         1,
         id_data_with_spline_model_with_outlier_info$spline_interpolated_height_flag)

#the next ifelse statement must be different if the column doesn't exist
if (("height_spline_iteration_outlier_was_flagged" %in% colnames(id_data_with_spline_model_with_outlier_info))){
  id_data_with_spline_model_with_outlier_info$height_spline_iteration_outlier_was_flagged <-
  ifelse(is.na(id_data_with_spline_model_with_outlier_info$height_spline_iteration_outlier_was_flagged),
         0,
         id_data_with_spline_model_with_outlier_info$height_spline_iteration_outlier_was_flagged)
} else {
  id_data_with_spline_model_with_outlier_info$height_spline_iteration_outlier_was_flagged <- 0  
}
  
#correct our column height_spline_iteration_outlier_was_flagged to zero if it isn't flagged
id_data_with_spline_model_with_outlier_info$height_spline_iteration_outlier_was_flagged <-
  ifelse(is.na(id_data_with_spline_model_with_outlier_info$height_spline_iteration_outlier_was_flagged),
         0,
         id_data_with_spline_model_with_outlier_info$height_spline_iteration_outlier_was_flagged)
         

id_data_with_spline_model_to_bind <- 
  id_data_with_spline_model_with_outlier_info[,c(
    "id_visit_date",
    "age_to_use",
    "manually_corrected_height",
    "spline_interpolated_height",
    "spline_interpolated_height_flag",
    "manually_corrected_height_flagged_as_an_outlier_by_spline_age",
    "height_spline_iteration_outlier_was_flagged")]

all_spline_height_age_interpolations <- 
  rbind(all_spline_height_age_interpolations,
        id_data_with_spline_model_to_bind)


#collect the id's which were used
all_ids_with_enough_id_data_for_spline_to_join <-
  data.frame(id=id_to_impute)

all_ids_with_enough_id_data_for_spline <-
  rbind(all_ids_with_enough_id_data_for_spline,
        all_ids_with_enough_id_data_for_spline_to_join)

#create a plot of this patient
spline_imputed_plot <- 
  ggplot(data=id_data_with_spline_model_with_outlier_info, 
         aes(x=age_to_use, 
             y=spline_interpolated_height)) + 
  geom_point(data=
               subset(id_data_with_spline_model_with_outlier_info, 
                      spline_interpolated_height_flag==0),
             aes(), 
             alpha=0.5, 
             colour="blue") +
  geom_point(data=
               subset(id_data_with_spline_model_with_outlier_info, 
                      spline_interpolated_height_flag==1),
             aes(), 
             alpha=0.5, 
             colour="orange") +
  geom_point(data=subset(id_data_with_spline_model_with_outlier_info, 
                         manually_corrected_height_flagged_as_an_outlier_by_spline_age==1),
             aes(y=manually_corrected_height), 
             alpha=0.5, 
             colour="red") +
  geom_line(aes(x=age_to_use, 
             y=spline_model_height_with_age)) + 
  labs(title="Blue is original data that is reasonable, 
       orange is interpolated data point, 
       red is original data that has been flagged as an outlier",
       subtitle=paste0("Number of outliers flagged = ",
                       sum(id_data_with_spline_model_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_spline_age==1),
                       ", Number of interpolated points = ",
                       sum(id_data_with_spline_model_with_outlier_info$spline_interpolated_height_flag==1),
                       ", St. Residual threshold:",
                       gam_scaled_residual_threshold_for_height))+
  themepowerpointtitle

spline_imputed_plot

dir.create(paste0("spline_height_interpolation_plots/"))
dir.create(paste0("spline_height_interpolation_plots/spline_df_points_less_", 
                  spline_degrees_of_freedom_less_than_points))
dir.create(paste0("spline_height_interpolation_plots/spline_df_points_less_", 
                  spline_degrees_of_freedom_less_than_points, 
                  "/residual_threshold_", 
                  spline_pearson_residual_threshold_for_height))
dir.create(paste0("spline_height_interpolation_plots/spline_df_points_less_", 
                  spline_degrees_of_freedom_less_than_points, 
                  "/residual_threshold_", 
                  spline_pearson_residual_threshold_for_height, 
                  "/all_individual_interpolations/"))

ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path=paste0("spline_height_interpolation_plots/spline_df_points_less_", 
                  spline_degrees_of_freedom_less_than_points, 
                  "/residual_threshold_", 
                  spline_pearson_residual_threshold_for_height, 
                  "/all_individual_interpolations/"),
       plot = spline_imputed_plot, 
       device="tiff",  
       width=10, 
       height=5, 
       compression = "lzw", limitsize=F)

if(sum(
  id_data_with_spline_model_with_outlier_info$manually_corrected_height_flagged_as_an_outlier_by_spline_age==1)>0){
  

dir.create(paste0("spline_height_interpolation_plots/spline_df_points_less_", 
                  spline_degrees_of_freedom_less_than_points, 
                  "/residual_threshold_", 
                  spline_pearson_residual_threshold_for_height, 
                  "/individual_interpolations_with_outliers"))
  
ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path=paste0("spline_height_interpolation_plots/spline_df_points_less_", 
                  spline_degrees_of_freedom_less_than_points, 
                  "/residual_threshold_", 
                  spline_pearson_residual_threshold_for_height, 
                  "/individual_interpolations_with_outliers"),
       plot = spline_imputed_plot, 
       device="tiff",  
       width=10, 
       height=5, 
       compression = "lzw", limitsize=F)
}

if(sum(
  id_data_with_spline_model_with_outlier_info$spline_interpolated_height_flag==1) > 0 ){
  
dir.create(paste0("spline_height_interpolation_plots/spline_df_points_less_", 
                  spline_degrees_of_freedom_less_than_points, 
                  "/residual_threshold_", 
                  spline_pearson_residual_threshold_for_height, 
                  "/individual_interpolations_leading_to_interpolated_points"))
  
ggsave(filename = paste0("id_", id_to_impute, ".tif"), 
       path = paste0("spline_height_interpolation_plots/spline_df_points_less_", 
                  spline_degrees_of_freedom_less_than_points, 
                  "/residual_threshold_", 
                  spline_pearson_residual_threshold_for_height, 
                  "/individual_interpolations_leading_to_interpolated_points"),
       plot = spline_imputed_plot, 
       device = "tiff",  
       width = 10, 
       height = 5, 
       compression = "lzw", 
       limitsize=F)
}
#close and loop to the next patient
}
#}}

```

```{r, using approxfun to interpolate between points that have less than 4 observations for height}
#create a frame to join to for linear interpolations
all_linear_interpolated_height_age_data <- 
  data.frame(NULL)

ids_with_insufficient_data_for_linear_interpolation_of_height <-
  data.frame(NULL)

all_ids_without_enough_data_for_spline_or_gam_height_interpolation_frame <-
  subset(data.frame(id=unique(bp_data$id)), 
         !(id %in% all_ids_with_enough_id_data_for_spline$id) & 
         !(id %in% all_ids_with_enough_id_data_with_age_weight_height_to_model_for_gam$id)   & 
         !(id %in% all_ids_with_enough_id_data_with_age_height_to_model_for_gam$id)   )

print("Number of patients to fit a straight line model to is: ")
cat(nrow(unique(all_ids_without_enough_data_for_spline_or_gam_height_interpolation_frame)))

for (id_to_impute in unique(all_ids_without_enough_data_for_spline_or_gam_height_interpolation_frame$id)){

id_data <- 
  subset(bp_data, id==id_to_impute)  

print("id is:")
print(id_to_impute)
print("number of rows is:")
print(nrow(id_data))

#skip if we don't have 2 data points to model and give a message
if (sum(!is.na(id_data$manually_corrected_height)) < 2) {
  print("Unable to interpolate this patient has less than 2 points available that are known")
  #collect the id before we skip out of the loop for this patient
  ids_with_insufficient_data_for_linear_interpolation_of_height_to_add <-
    data.frame(id=unique(id_data$id))
  #bind that outside of the loop
  ids_with_insufficient_data_for_linear_interpolation_of_height <-
    rbind(
      ids_with_insufficient_data_for_linear_interpolation_of_height,
      ids_with_insufficient_data_for_linear_interpolation_of_height_to_add
    )
  
}
if (sum(!is.na(id_data$manually_corrected_height)) < 2) next

id_data <-
  id_data[,c(
    "id",
    "manually_corrected_height",
    "age_to_use",
    "id_visit_date")]

#fit a linear interpolation model
id_data$linear_interpolation <- 
  stats::approx(
    x=id_data$age_to_use,
    y=id_data$manually_corrected_height,
    xout=id_data$age_to_use,
    method="linear",
    rule=1:1)$y # rule=1 means we don't extrapolate either side. if you use rule=2, then the adjacent data point is used for extrapolation. can use rule = 2:1 to do a different rule at beginning and end of data

#check to see if we have an interpolated point and flag it - this must include that we don't extrapolate

id_data$linear_interpolated_height_flag <-
  ifelse(is.na(id_data$manually_corrected_height) &
           !is.na(id_data$linear_interpolation),
         1,
         0)

id_data$linear_interpolated_height <-
  ifelse(is.na(id_data$manually_corrected_height),
         id_data$linear_interpolation,
         id_data$manually_corrected_height)

  
linear_interpolated_data_to_bind <- 
  id_data[,c(
    "id_visit_date",
    "age_to_use",
    "manually_corrected_height",
    "linear_interpolated_height",
    "linear_interpolated_height_flag")]

all_linear_interpolated_height_age_data <- 
  rbind(all_linear_interpolated_height_age_data,
        linear_interpolated_data_to_bind)

linear_interpolated_plot <- 
  
  ggplot(data=linear_interpolated_data_to_bind, 
         aes(x=age_to_use, 
             y=linear_interpolated_height)) + 
  
  geom_point(data=subset(linear_interpolated_data_to_bind, 
                         linear_interpolated_height_flag==0),
    aes(), alpha=0.5, colour="blue") +
  
  geom_point(data=subset(linear_interpolated_data_to_bind, 
                         linear_interpolated_height_flag==1),
    aes(), alpha=0.5, colour="orange") +
  
  geom_line(aes(x=age_to_use, 
             y=linear_interpolated_height)) + 
  
  labs(title="Blue is original data, 
       orange is interpolated missing data point, 
       no outliers are flagged by linear interpolation",
       subtitle=paste0("Number of interpolated points = ",
                       sum(linear_interpolated_data_to_bind$linear_interpolated_height_flag==1))) +
  themepowerpointtitle

linear_interpolated_plot

dir.create("linear_height_interpolation_plots")
dir.create("linear_height_interpolation_plots/individual_imputations")

ggsave(filename=paste0("id_", id_to_impute, ".tif"), 
       path = paste0("linear_height_interpolation_plots/individual_imputations"),
       plot = linear_interpolated_plot, 
       device="tiff",  
       width=10, 
       height=5, 
       compression = "lzw", 
       limitsize=F)

if(sum(
  linear_interpolated_data_to_bind$linear_interpolated_height_flag==1) > 0 ){
dir.create("linear_height_interpolation_plots/individual_interpolations_leading_to_interpolated_points")  
  
ggsave(filename = paste0("id_", id_to_impute, ".tif"), 
       path = "linear_height_interpolation_plots/individual_interpolations_leading_to_interpolated_points",
       plot = linear_interpolated_plot, 
       device = "tiff",  
       width = 10, 
       height = 5, 
       compression = "lzw", 
       limitsize=F)


}
}
sink("linear_height_interpolation_plots/please_note_that_linear_interpolation_does_not_detect_outliers")
print("please_note_that_linear_interpolation_does_not_detect_outliers")
print("You have to change the settings within approxfun to cause linear interpolation to extrapolate")
sink()

```

```{r, join in all of my height imputations}
all_gam_height_weight_age_interpolations_to_join <-
  all_gam_height_weight_age_interpolations

all_gam_height_age_interpolations_to_join <-
  all_gam_height_age_interpolations

all_spline_height_age_interpolations_to_join <-
  all_spline_height_age_interpolations

all_linear_interpolated_height_age_data_to_join <- 
  all_linear_interpolated_height_age_data

#get rid of some unnecessary columns that will cause column duplication
all_spline_height_age_interpolations_to_join$age_to_use <- NULL

all_spline_height_age_interpolations_to_join$manually_corrected_height <- NULL

all_linear_interpolated_height_age_data_to_join$age_to_use <- NULL

all_linear_interpolated_height_age_data_to_join$manually_corrected_height <- NULL

bp_data_with_all_height_imputations_a <-
  left_join(
    bp_data, 
    all_linear_interpolated_height_age_data_to_join,
    by="id_visit_date"
  )

bp_data_with_all_height_imputations_b <-
  left_join(
    bp_data_with_all_height_imputations_a, 
    all_spline_height_age_interpolations_to_join,
    by="id_visit_date"
  )

bp_data_with_all_height_imputations_c <-
  left_join(
    bp_data_with_all_height_imputations_b, 
    all_gam_height_age_interpolations_to_join,
    by="id_visit_date"
  )

bp_data_with_all_height_imputations_d <-
  left_join(
    bp_data_with_all_height_imputations_c, 
    all_gam_height_weight_age_interpolations_to_join,
    by="id_visit_date"
  )

print("This number should be zero to prove we haven't duplicated rows during the join:")
nrow(bp_data_with_all_height_imputations_d) - nrow(bp_data)

#then we need to correct values of NA for those that haven't had an interpolation for our flags
#correct gam with height and weight as covariate
bp_data_with_all_height_imputations_d$gam_interpolated_height_using_age_weight_flag <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$gam_interpolated_height_using_age_weight_flag),
    0,
    bp_data_with_all_height_imputations_d$gam_interpolated_height_using_age_weight_flag
  )

bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight),
    0,
    bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight
  )

bp_data_with_all_height_imputations_d$height_gam_age_weight_iteration_outlier_was_flagged <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$height_gam_age_weight_iteration_outlier_was_flagged),
    0,
    bp_data_with_all_height_imputations_d$height_gam_age_weight_iteration_outlier_was_flagged
  )
#correct gam with just age
bp_data_with_all_height_imputations_d$gam_interpolated_height_using_age_flag <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$gam_interpolated_height_using_age_flag),
    0,
    bp_data_with_all_height_imputations_d$gam_interpolated_height_using_age_flag
  )

bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age),
    0,
    bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age
  )

bp_data_with_all_height_imputations_d$height_gam_age_iteration_outlier_was_flagged <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$height_gam_age_iteration_outlier_was_flagged),
    0,
    bp_data_with_all_height_imputations_d$height_gam_age_iteration_outlier_was_flagged
  )
#correct spline with just age
bp_data_with_all_height_imputations_d$spline_interpolated_height_flag <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$spline_interpolated_height_flag),
    0,
    bp_data_with_all_height_imputations_d$spline_interpolated_height_flag
  )

bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_spline_age <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_spline_age),
    0,
    bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_spline_age
  )

bp_data_with_all_height_imputations_d$height_spline_iteration_outlier_was_flagged <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$height_spline_iteration_outlier_was_flagged),
    0,
    bp_data_with_all_height_imputations_d$height_spline_iteration_outlier_was_flagged
  )

#correct linear interpolation flag, remember no outliers in this method
bp_data_with_all_height_imputations_d$linear_interpolated_height_flag <-
  ifelse(
    is.na(bp_data_with_all_height_imputations_d$linear_interpolated_height_flag),
    0,
    bp_data_with_all_height_imputations_d$linear_interpolated_height_flag
  )
#first, we check whether outliers can be flagged by more than one mehtod

bp_data_with_all_height_imputations_d$both_gam_outlier <-
  ifelse(bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight==1 & bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age==1,
         1,
         0)
print("Summary of points declared outliers. Note that both GAM models can be run and flag outliers, so you have to adjust the GAM age outliers by those already counted by GAM age and weight")
print("Number flagged by GAM height on age with weight covariate:")
sum(bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age_weight)
print("Remaining number flagged by GAM height on age with no covariate:")
sum(bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_gam_age) -
sum(bp_data_with_all_height_imputations_d$both_gam_outlier)
print("Remaining number flagged by smooth spline:")
sum(bp_data_with_all_height_imputations_d$manually_corrected_height_flagged_as_an_outlier_by_spline_age)
print("Remember that linear interpolation does not flag outliers")
```


```{r, rationalise the file name}
bp_data <- 
  bp_data_with_all_height_imputations_d
```


```{r, use the hierarchy to insert height imputations and give us a column that tells us how our height was interpolated}
#if we have a value for linear interpolation then we use it as bottom rung of the hierarchy
bp_data$interpolated_height <-
  ifelse(!is.na(bp_data$linear_interpolated_height),
         bp_data$linear_interpolated_height,
         NA)
#categorise the method we have used if we have used that
bp_data$interpolated_height_method <-
  ifelse(!is.na(bp_data$linear_interpolated_height),
         "linear_interpolation",
         NA)

#we use a spline value in preference to this if we have it (note, we shouldnt have both if we've only run the algorithm through necessary patients) It may be in future, because you do have the option of running the spline and the linear interpolation through also, I've just not done that to prevent outliers being flagged by some methods and not by others and therefore creating ambiguity
bp_data$interpolated_height <-
  ifelse(!is.na(bp_data$spline_interpolated_height),
         bp_data$spline_interpolated_height,
         bp_data$interpolated_height)
#categorise the method we have used if we have used that
bp_data$interpolated_height_method <-
  ifelse(!is.na(bp_data$spline_interpolated_height),
         "spline_interpolation",
         bp_data$interpolated_height_method)

#we use a gam model with just height from age if we have that
bp_data$interpolated_height <-
  ifelse(!is.na(bp_data$gam_interpolated_height_using_age),
         bp_data$gam_interpolated_height_using_age,
         bp_data$interpolated_height)
#categorise the method we have used if we have used that
bp_data$interpolated_height_method <-
  ifelse(!is.na(bp_data$gam_interpolated_height_using_age),
         "gam_interpolation_just_age",
         bp_data$interpolated_height_method)

#we use a gam model with height from age and weight if we have that
bp_data$interpolated_height <-
  ifelse(!is.na(bp_data$gam_interpolated_height_using_age_weight),
         bp_data$gam_interpolated_height_using_age_weight,
         bp_data$interpolated_height)
#categorise the method we have used if we have used that
bp_data$interpolated_height_method <-
  ifelse(!is.na(bp_data$gam_interpolated_height_using_age_weight),
         "gam_interpolation_from_age_and_weight",
         bp_data$interpolated_height_method)

#if we dont have an interpolated height, but we do have a manually_corrected_height, then we just insert the manually_corrected_height. This will not have been flagged as an outlier otherwise there would be an interpolated value for it
bp_data$interpolated_height <-
  ifelse(is.na(bp_data$interpolated_height),
         bp_data$manually_corrected_height,
         bp_data$interpolated_height)

#if we have a value for the original and our interpolation is the same as the original, then we can say that the value we are using is original
bp_data$interpolated_height_method <-
  ifelse(!is.na(bp_data$manually_corrected_height_before_outlier_corrections) & 
           bp_data$manually_corrected_height_before_outlier_corrections==bp_data$interpolated_height,
         "original_measurement",
         bp_data$interpolated_height_method)

#then we can say that any remaining NA values we are unable to interpolate
bp_data$interpolated_height_method <-
  ifelse(is.na(bp_data$interpolated_height_method),
         "unable_to_interpolate",
         bp_data$interpolated_height_method)

print("Check that the number we are unable to interpolate is the same as the number we don't have an interpolated height value for. This number should be zero:")
sum(is.na(bp_data$interpolated_height)) - sum(bp_data$interpolated_height_method=="unable_to_interpolate")
print("Summary statistics for height before outlier corrections:")
descr(bp_data$manually_corrected_height_before_outlier_corrections)
print("Summary statistics for height after outlier corrections:")
descr(bp_data$interpolated_height)
print("Number of readings before outlier corrections")
sum(!is.na(bp_data$manually_corrected_height_before_outlier_corrections))
print("Number of registered methods of interpolation")
sum(!is.na(bp_data$interpolated_height_method))
print("This number should NOT be zero because we should have extra points interpolated, otherwise please review interpolation hierarchy")
sum(!is.na(bp_data$manually_corrected_height_before_outlier_corrections)) - sum(!is.na(bp_data$interpolated_height_method))
print("The interpolation method frequencies are as follows:")
freq(bp_data$interpolated_height_method)


height_interpolation_visual_check <-
  bp_data[,c(
    "id",
    "manually_corrected_height",
    "interpolated_height",
    "interpolated_height_method"
  )]

print("You can look at height_interpolation_visual_check to see what's happening. We could increase data further by extrapolating for patients with some readings. Some patients don't have any readings - they could be imputed completely, for instance with age, sex, weight and centre. Wouldn't want to have them change height, but could do multiple imputation of height that doesn't change in each dataset. Could also detect outlying patients and readings from those without many readings in the data set as a whole")
```

```{r, we want an overall flag for whether a value has been interpolated because it is missing, or interpolated because it is an outlier}
bp_data$interpolated_height_flag_because_missing <-
  ifelse(is.na(bp_data$manually_corrected_height_before_outlier_corrections) &
           !is.na(bp_data$interpolated_height),
         1,
         0)
#freq(bp_data$interpolated_height_flag_because_missing)

bp_data$interpolated_height_flag_because_outlier <-
  ifelse(!is.na(bp_data$manually_corrected_height_before_outlier_corrections) &
           bp_data$manually_corrected_height_before_outlier_corrections!=bp_data$interpolated_height,
         1,
         0)
#freq(bp_data$interpolated_height_flag_because_outlier)

print("we have interpolated the following number of heights because they were missing:")
sum(bp_data$interpolated_height_flag_because_missing)
print("we have interpolated the following number of heights because they were flagged as outliers and replaced with interpolation:")
sum(bp_data$interpolated_height_flag_because_outlier)
print("Remember, you can adjust the residual thresholds to flag things as outliers at the top of this file if necessary")
```


```{r, end of file so save all the listed dataframes into the parent directory}
write.csv(bp_data, "bp_data_after_file_16.csv")
save_bp_files_function(
  parent_directory=location_of_data_files,
  parent_file="file_18")
Sys.time()
```
